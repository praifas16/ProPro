<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom General</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Inconsolata:wght@200..900&family=Jost:ital,wght@0,100..900;1,100..900&family=Signika:wght@300..700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: "Comfortaa", "Inconsolata", "Jost", "Signika", sans-serif;
            background-color: #2f2f2f;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .topbar {
            background-color: #2e2e2e;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0px 2px 4px rgba(177, 177, 177, 0.1);
            position: relative;
            z-index: 2;
        }
        
        .topbar .search-bar {
            flex-grow: 1;
            display: flex;
            justify-content: flex-start;
            position: relative;
            padding-left: 480px;
        }
        
        .topbar .search-bar input {
            width: 400px;
            padding: 5px 10px 5px 35px;
            border-radius: 20px;
            border: 1px solid #717171;
            background-color: #333;
            color: #979797;
            font-size: 16px;
            position: relative;
            z-index: 1;
        }
        
        .topbar .search-bar .fas {
            position: absolute;
            left: 490px;
            top: 50%;
            transform: translateY(-50%);
            color: #979797;
            z-index: 2;
        }
        
        .topbar .user-section {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        #user-email {
            color: white;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .user-icon {
            cursor: pointer;
            position: relative;
        }
        
        .user-icon i {
            font-size: 30px;
            color: white;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 50px;
            background-color: #fff;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
            z-index: 1000;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 10px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }
        
        .dropdown-menu a:hover {
            background-color: #f0f0f0;
        }
        
        .sidebar {
            width: 100px;
            background-color: #333;
            color: white;
            height: 100vh;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            top: 0;
            z-index: 1;
        }
        
        .menu-items {
            margin-top: 40px;
        }
        
        .sidebar a {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            padding: 10px;
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 12px;
            text-align: center;
        }
        
        .sidebar a:hover {
            background-color: #5f5f5f;
            border-radius: 4px;
            width: 80%;
            text-align: center;
        }
        
        .sidebar i {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .main-sidebar {
            width: 180px;
            background-color: #333;
            padding: 10px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            margin-left: 100px;
            position: fixed;
            top: 40px;
            bottom: 0;
        }
        
        .main-sidebar a {
            display: flex;
            align-items: center;
            color: #ccc;
            padding: 10px 15px;
            text-decoration: none;
            font-size: 14px;
        }
        
        .main-sidebar a i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .main-sidebar a:hover {
            background-color: #444;
            color: #fff;
        }
        
        .main-sidebar a.active {
            background-color: #9c0909;
            color: #b51d1d;
        }
        
        .main-sidebar .main-channel {
            margin-top: 15px;
        }
        
        .main-sidebar .main-channel a {
            padding-left: 20px;
            font-size: 12px;
        }
        
        .course-name {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #fff;
            background-color: #444;
            margin-bottom: 10px;
        }
        
        .course-name i {
            margin-right: 10px;
        }
        
        #searchResults {
            background-color: rgb(86, 86, 86);
            color: black;
            position: absolute;
            z-index: 1000;
            width: 400px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            top: 38px;
        }
        
        #searchResults .result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #a3a3a3;
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        
        #searchResults .result-item:hover {
            background-color: #989898;
        }
        
        .search-info {
            display: flex;
            flex-direction: column;
        }
        
        .search-info span {
            font-size: 14px;
            color: #b2b2b2;
        }
        
        .search-info p {
            margin: 0;
            font-size: 16px;
            color: #b2b2b2;
        }
        
        .content {
            flex-grow: 1;
            background-color: #2c2c2c;
            display: flex;
            flex-direction: column;
            margin-left: 280px;
            padding-top: 0px;
        }
        
        .content-header {
            background-color: #202020;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            font-family: "Comfortaa", Arial, sans-serif;
        }
        
        .content-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .content-header .header-options {
            display: flex;
            align-items: center;
        }
        
        .content-header .header-options a {
            margin-right: 15px;
            color: #ccc;
            text-decoration: none;
            font-size: 14px;
        }
        
        .content-header .header-options a:hover {
            color: #fff;
        }
        
        .content-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .document-id-section {
            margin-top: 20px;
            padding: 10px;
            color: #fff;
        }
        
        .document-id-section label {
            color: #ccc;
        }
        
        .document-id-section input {
            width: 150px;
            padding: 5px;
            margin-right: 10px;
        }
        
        .document-id-section button {
            padding: 5px 10px;
            background-color: #2e3956;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .document-id-section button:hover {
            background-color: #6b2e39;
        }
        
        .post {
            background-color: #3b3b3b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-family: "Comfortaa", Arial, sans-serif;
        }
        
        .post-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .post-header .post-date {
            font-size: 12px;
            color: #bbb;
        }
        
        .post-content {
            font-size: 14px;
            color: #ddd;
        }
        
        .reply-section {
            margin-top: 10px;
            border-top: 1px solid #444;
            padding-top: 10px;
        }
        
        .reply {
            background-color: #2c2c2c;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .reply p {
            margin: 0;
            font-size: 14px;
            color: #bbb;
        }
        
        .reply .reply-author {
            font-size: 12px;
            color: #888;
        }
        
        .start-post {
            margin-top: 20px;
            text-align: center;
        }
        
        .start-post button {
            background-color: #2e3956;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .start-post button:hover {
            background-color: #6b2e39;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            color: black;
        }
        
        .modal-content textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            resize: none;
        }
        
        .modal-content .attachments {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .modal-content .attachments i {
            cursor: pointer;
            font-size: 20px;
            color: #333;
        }
        
        .modal-content .attachments i:hover {
            color: #555;
        }
        
        .modal-content button {
            background-color: #2e3956;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            float: right;
        }
        
        .modal-content button:hover {
            background-color: #6b2e39;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        #fileContainer {
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
            color: #333;
            margin-top: 10px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        #fileContainer a {
            color: #4caf50;
            text-decoration: none;
            font-weight: bold;
        }
        
        #fileContainer a:hover {
            text-decoration: underline;
        }
        
        .file-link {
            background-color: #403f3f;
            color: #ffffff;
            text-decoration: none;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
        }
        
        .file-link:hover {
            background-color: #6b2e39;
        }
        
        .youtube-iframe {
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .external-link {
            color: #f7f7f7;
            text-decoration: none;
            font-weight: bold;
            padding: 8px;
            display: inline-block;
        }
        
        .external-link:hover {
            background-color: #6b2e39;
            border-radius: 8px;
        }
        
        .notification-badge {
            position: absolute;
            top: 0;
            right: 25px;
            background-color: rgb(255, 157, 0);
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="ค้นหา (Cmd+E)" id="searchInput" />
            <div id="searchResults"></div>
        </div>
        <div class="user-section">
            <div id="user-email"></div>
            <div class="user-icon" id="userIcon">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="#">Profile</a>
                <a href="#">Log out</a>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="menu-items">
            <a href="studenthead.html?email="><i class="fa fa-chalkboard-teacher"></i><span>Classroom</span></a
        >
        <a href="Chat.html?email="
          ><i class="fa fa-comments"></i><span>Chat</span></a
        >
        <a
          href="Notifications.html?email="
          id="notificationMenu"
          style="position: relative"
        >
          <i class="fa fa-bell"></i>
          <span>Notifications</span>
          <!-- Badge สำหรับการแจ้งเตือน -->
          <span class="notification-badge" id="notificationBadge">0</span>
        </a>
            <a href="Assignment.html?email="><i class="fa fa-tasks"></i><span>Assignment</span></a
        >
        <a href="Call.html?email="
          ><i class="fa fa-phone"></i><span>Call</span></a
        >
      </div>
    </div>

    <div class="team-grid" id="team-grid"></div>

    <div class="main-sidebar">
      <div class="course-name" id="courseName">
        <i class="fas fa-users"></i>
      </div>
      <div class="document-id-section">
        <label for="documentId">Document ID:</label>
        <input type="text" id="documentId" readonly />
        <button onclick="copyDocumentId()">Copy</button>
      </div>
      <a href="general.html?classroom={{classroom}}&email={{email}}"
        ><i class="fa fa-home"></i> Home page</a
      >

      <a href="Orderwork.html?classroom={{classroom}}&email={{email}}"
        ><i class="fa fa-book"></i> Assignments</a>
        </div>
    </div>

    <div class="content">
        <div class="content-header">
            <h2>General</h2>
            <div class="header-options">
                <a href="#">Posts</a>
                <a href="#">Files</a>
            </div>
        </div>
        <div class="content-body">
            <div id="postContainer">
                <!-- Posts will be dynamically inserted here -->
            </div>
            <div class="start-post">
                <button onclick="openModal()">Start a post</button>
            </div>
        </div>
    </div>

    <!-- Modal for Creating Post -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>New Post</h2>
            <textarea id="postMessage" placeholder="Type a message"></textarea>

            <!-- แสดงตัวอย่างภาพ -->
            <div id="imageContainer"></div>

            <!-- แสดงชื่อไฟล์ -->
            <div id="fileContainer" style="margin-top: 10px"></div>

            <div class="attachments">
                <i class="fas fa-paperclip" onclick="attachFile()"></i>
                <i class="fas fa-link" onclick="attachLink()"></i>
                <i class="fas fa-image" onclick="attachImage()"></i>
            </div>
            <button onclick="submitPost()">Post</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyC1qX4ttFX42SzVFbg6LqjNJv9rRSepYXw",
            authDomain: "project-63a86.firebaseapp.com",
            projectId: "team-1849c",
            storageBucket: "team-1849c.appspot.com",
            messagingSenderId: "448111875731",
            appId: "1:448111875731:web:6180e0c46cc10593051f66",
            measurementId: "G-SR4EFC2VFC",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        console.log("Firebase Loaded:", firebase.apps.length > 0); // ตรวจสอบการโหลด Firebase

        // Function to search email or username in both Teacher and Student collections
        document
            .getElementById("searchInput")
            .addEventListener("input", function(event) {
                var query = event.target.value.toLowerCase();
                var resultsContainer = document.getElementById("searchResults");

                if (query.length > 0) {
                    resultsContainer.innerHTML = "";
                    let allResults = new Set();

                    // ค้นหาจากคอลเล็กชัน Student
                    db.collection("Student")
                        .orderBy("Username")
                        .startAt(query)
                        .endAt(query + "\uf8ff")
                        .get()
                        .then(function(querySnapshot) {
                            querySnapshot.forEach(function(doc) {
                                var userData = doc.data();
                                allResults.add(
                                    userData.Username + " (" + userData.Email + ")"
                                );
                            });

                            // ค้นหาอีเมล
                            return db
                                .collection("Student")
                                .orderBy("Email")
                                .startAt(query)
                                .endAt(query + "\uf8ff")
                                .get();
                        })
                        .then(function(querySnapshot) {
                            querySnapshot.forEach(function(doc) {
                                var userData = doc.data();
                                allResults.add(
                                    userData.Username + " (" + userData.Email + ")"
                                );
                            });

                            // ค้นหาจากคอลเล็กชัน Teacher
                            return db
                                .collection("Teacher")
                                .orderBy("Username")
                                .startAt(query)
                                .endAt(query + "\uf8ff")
                                .get();
                        })
                        .then(function(querySnapshot) {
                            querySnapshot.forEach(function(doc) {
                                var userData = doc.data();
                                allResults.add(
                                    userData.Username + " (" + userData.Email + ")"
                                );
                            });

                            // ค้นหาอีเมลจาก Teacher
                            return db
                                .collection("Teacher")
                                .orderBy("Email")
                                .startAt(query)
                                .endAt(query + "\uf8ff")
                                .get();
                        })
                        .then(function(querySnapshot) {
                            querySnapshot.forEach(function(doc) {
                                var userData = doc.data();
                                allResults.add(
                                    userData.Username + " (" + userData.Email + ")"
                                );
                            });

                            // แสดงผลลัพธ์
                            allResults.forEach(function(resultItem) {
                                var div = document.createElement("div");
                                div.className = "result-item";
                                div.textContent = resultItem;
                                resultsContainer.appendChild(div);
                            });
                        })
                        .catch(function(error) {
                            console.log("Error getting documents: ", error);
                        });
                } else {
                    resultsContainer.innerHTML = "";
                }
            });

        // ดึงพารามิเตอร์ email และ classroom จาก URL
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get("email");
        const classroomName = urlParams.get("classroom");

        let userRole = ""; // เก็บ role ของผู้ใช้
        let username = ""; // เก็บชื่อผู้ใช้

        if (email) {
            document.getElementById("user-email").textContent = email;

            document
                .querySelectorAll(".menu-items a, .main-sidebar a")
                .forEach((link) => {
                    const url = new URL(link.href);
                    url.searchParams.set("email", email);
                    if (classroomName) {
                        url.searchParams.set("classroom", classroomName);
                    }
                    link.href = url.toString();
                });
        }
        if (classroomName) {
            document.getElementById("courseName").innerHTML =
                '<i class="fas fa-users"></i> ' + classroomName;
        } else {
            document.getElementById("courseName").innerHTML =
                '<i class="fas fa-users"></i> No classroom';
        }

        console.log("Classroom:", classroomName);
        console.log("Email:", email);

        async function fetchUserData(email) {
            let userRole = "";
            let username = "";

            if (email) {
                document.getElementById("user-email").textContent = email;

                // Check Teacher collection
                let querySnapshot = await db
                    .collection("Teacher")
                    .where("Email", "==", email)
                    .get();
                if (!querySnapshot.empty) {
                    const data = querySnapshot.docs[0].data();
                    userRole = "Teacher";
                    username = data.Username;
                } else {
                    // Check Student collection
                    querySnapshot = await db
                        .collection("Student")
                        .where("Email", "==", email)
                        .get();
                    if (!querySnapshot.empty) {
                        const data = querySnapshot.docs[0].data();
                        userRole = "Student";
                        username = data.Username;
                    }
                }

                // เก็บข้อมูล Username และ Role ใน window object เพื่อใช้งานต่อ
                window.userRole = userRole;
                window.username = username;
            }
        }

        // เรียกฟังก์ชันนี้เมื่อโหลดหน้าเสร็จ
        fetchUserData(email);

        // Function to fetch posts and display them based on type
        function fetchPosts() {
            const postContainer = document.getElementById("postContainer");
            postContainer.innerHTML = ""; // Clear previous posts

            db.collection("Post")
                .where("ClassroomName", "==", classroomName)
                .orderBy("Timestamp", "asc")
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const postDiv = document.createElement("div");
                        postDiv.classList.add("post");

                        const postHeader = document.createElement("div");
                        postHeader.classList.add("post-header");
                        const postAuthor = document.createElement("h3");
                        postAuthor.textContent = data.Username;
                        const postDate = document.createElement("span");
                        postDate.classList.add("post-date");
                        postDate.textContent = new Date(
                            data.Timestamp.toDate()
                        ).toLocaleString();

                        const postContent = document.createElement("div");
                        postContent.classList.add("post-content");

                        // ตรวจสอบว่ามีข้อความหรือไม่
                        if (data.Message) {
                            const postText = document.createElement("p");
                            postText.textContent = data.Message; // เพิ่มข้อความ
                            postContent.appendChild(postText);
                        }

                        // ตรวจสอบประเภทของเนื้อหาและแสดงผล
                        if (data.PostType === "รูปภาพ") {
                            // โพสต์รูปภาพ
                            const img = document.createElement("img");
                            img.src = data.Content;
                            img.style.maxWidth = "100%";
                            img.style.borderRadius = "10px";
                            postContent.appendChild(img);
                        }

                        if (data.PostType === "ไฟล์") {
                            // โพสต์ไฟล์
                            const fileLink = document.createElement("a");
                            fileLink.href = data.Content;
                            fileLink.target = "_blank"; // เปิดในแท็บใหม่
                            fileLink.textContent = "ดาวน์โหลดไฟล์";
                            fileLink.classList.add("file-link");
                            postContent.appendChild(fileLink);
                        }

                        if (data.PostType === "ลิงก์") {
                            // โพสต์ลิงก์
                            if (data.Content.includes("youtube.com/watch")) {
                                const videoId = data.Content.split("v=")[1];
                                const iframe = document.createElement("iframe");
                                iframe.width = "560";
                                iframe.height = "315";
                                iframe.src = `https://www.youtube.com/embed/${videoId}`;
                                iframe.frameBorder = "0";
                                iframe.allow =
                                    "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                                iframe.allowFullscreen = true;

                                // เพิ่มคลาสสำหรับ iframe
                                iframe.classList.add("youtube-iframe");

                                postContent.appendChild(iframe);
                            } else {
                                const link = document.createElement("a");
                                link.href = data.Content;
                                link.target = "_blank"; // เปิดในแท็บใหม่
                                link.textContent = data.Content;

                                // เพิ่มคลาสสำหรับลิงก์
                                link.classList.add("external-link");

                                postContent.appendChild(link);
                            }
                        }

                        postHeader.appendChild(postAuthor);
                        postHeader.appendChild(postDate);
                        postDiv.appendChild(postHeader);
                        postDiv.appendChild(postContent);

                        postContainer.appendChild(postDiv);
                    });
                })
                .catch((error) => {
                    console.error("Error fetching posts: ", error);
                });
        }

        fetchPosts();

        // Function to submit a post and send notifications
        async function submitPost() {
            console.log("Submitting post...");

            const message = document.getElementById("postMessage").value.trim();
            if (message === "") {
                alert("Message is required.");
                return;
            }
            console.log("Message:", message); // แสดงข้อความที่โพสต์

            const postType = determinePostType(message);
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const classroomName = urlParams.get("classroom");
            const email = urlParams.get("email");

            console.log("Classroom:", classroomName);
            console.log("Email:", email);

            if (!classroomName || !email) {
                alert("Classroom or Email is missing!");
                return;
            }

            try {
                // บันทึกข้อมูลโพสต์ลง Firestore
                await db.collection("Post").add({
                    ClassroomName: classroomName, // ชื่อห้องเรียนที่ดึงจาก URL
                    Username: window.username, // ชื่อผู้ใช้ที่ได้จาก fetchUserData
                    Email: email, // อีเมลที่ดึงจาก URL
                    PostType: postType,
                    Content: message,
                    Timestamp: timestamp,
                });

                // สร้างการแจ้งเตือนให้สมาชิกในห้องเรียนทุกคน
                const subjectDoc = await db
                    .collection("Subjects")
                    .doc(classroomName)
                    .get();
                const subjectData = subjectDoc.data();

                if (subjectData && subjectData.Members) {
                    const members = subjectData.Members;

                    for (const memberEmail of members) {
                        if (memberEmail !== email) {
                            // เพิ่มเงื่อนไขไม่ให้แจ้งเตือนตัวเอง
                            // เพิ่มการแจ้งเตือนให้สมาชิก
                            await db.collection("Notifications").add({
                                To: memberEmail,
                                Message: `${window.username} ได้โพสต์ ${postType} ในห้องเรียน ${classroomName}`,
                                Type: "Post",
                                ClassroomName: classroomName,
                                PostType: postType,
                                CreatedAt: timestamp,
                                isRead: false,
                            });
                        }
                    }
                }

                alert("Post created successfully and notifications sent!");
                closeModal(); // ปิด modal เมื่อโพสต์สำเร็จ
                setTimeout(() => {
                    window.location.reload(); // รีเฟรชหน้าเว็บหลังจาก modal ถูกปิด
                }, 300); // หน่วงเวลาเล็กน้อยเพื่อให้ modal ปิดก่อน
            } catch (error) {
                console.error(
                    "Error creating post or sending notifications: ",
                    error
                );
            }
        }

        // Function to determine post type based on content
        function determinePostType(content) {
            if (content.includes("http")) {
                return "ลิงก์";
            } else if (content.endsWith(".jpg") || content.endsWith(".png")) {
                return "รูปภาพ";
            } else {
                return "ข้อความ";
            }
        }

        function determinePostType(content) {
            // ตรวจสอบประเภทของโพส
            if (content.includes("http")) {
                return "ลิงก์";
            } else if (content.endsWith(".jpg") || content.endsWith(".png")) {
                return "รูปภาพ";
            } else {
                return "ข้อความ";
            }
        }

        // Function to open modal
        function openModal() {
            document.getElementById("postModal").style.display = "flex";
        }

        // Function to close modal
        function closeModal() {
            document.getElementById("postModal").style.display = "none";
        }

        let attachedFileURL = "";
        let attachedFileType = "";

        // ฟังก์ชันสำหรับการแนบและอัปโหลดไฟล์ไปยัง Firebase Storage
        function attachFile() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "*"; // รับไฟล์ทุกประเภท
            input.onchange = (e) => {
                const file = e.target.files[0]; // รับไฟล์ที่เลือกจากผู้ใช้

                if (file) {
                    // ตรวจสอบขนาดไฟล์ไม่เกิน 5GB (5 * 1024 * 1024 * 1024 ไบต์)
                    if (file.size > 5 * 1024 * 1024 * 1024) {
                        alert("ขนาดไฟล์เกิน 5GB");
                        return;
                    }

                    // สร้างตัวชี้อ้างอิงไปยัง Firebase Storage
                    const storageRef = firebase.storage().ref("uploads/" + file.name);

                    // อัปโหลดไฟล์ไปยัง Firebase Storage
                    const uploadTask = storageRef.put(file);

                    // ฟังก์ชันการติดตามสถานะการอัปโหลด
                    uploadTask.on(
                        "state_changed",
                        (snapshot) => {
                            // สามารถแสดงความคืบหน้าของการอัปโหลดได้ที่นี่
                            const progress =
                                (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log("Upload is " + progress + "% done");
                        },
                        (error) => {
                            console.error("เกิดข้อผิดพลาดในการอัปโหลดไฟล์: ", error);
                        },
                        () => {
                            // เมื่ออัปโหลดเสร็จสมบูรณ์ ให้ดึง URL ของไฟล์
                            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                console.log("ไฟล์สามารถเข้าถึงได้ที่", downloadURL);

                                // แสดงชื่อไฟล์และขนาดไฟล์ใน UI
                                const fileContainer =
                                    document.getElementById("fileContainer");
                                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2); // คำนวณขนาดไฟล์เป็น MB
                                fileContainer.innerHTML = `<a href="${downloadURL}" target="_blank">${file.name}</a> (${fileSizeMB} MB)`;
                                fileContainer.style.display = "block"; // แสดงกล่อง fileContainer

                                // เก็บ URL ของไฟล์และประเภทของไฟล์ไว้ใช้งานภายหลัง
                                attachedFileURL = downloadURL;
                                attachedFileType = "ไฟล์";
                            });
                        }
                    );
                }
            };
            input.click();
        }

        function attachImage() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*"; // รับเฉพาะไฟล์รูปภาพ
            input.onchange = (e) => {
                const file = e.target.files[0]; // รับไฟล์ที่ผู้ใช้อัปโหลด

                // ตรวจสอบขนาดไฟล์ ถ้าเกิน 5MB จะไม่ทำการอัปโหลด
                if (file.size > 5 * 1024 * 1024) {
                    alert("ขนาดไฟล์รูปภาพเกิน 5MB กรุณาเลือกไฟล์ที่มีขนาดเล็กกว่า 5MB");
                    return;
                }

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.createElement("img");
                        img.src = event.target.result;
                        img.style.maxWidth = "100%";
                        img.style.borderRadius = "10px";

                        const imageContainer = document.getElementById("imageContainer");
                        imageContainer.innerHTML = "";
                        imageContainer.appendChild(img);
                    };

                    reader.readAsDataURL(file);

                    const storageRef = firebase.storage().ref("images/" + file.name);
                    const uploadTask = storageRef.put(file);

                    uploadTask.on(
                        "state_changed",
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log("Upload is " + progress + "% done");
                        },
                        (error) => {
                            console.error("Error during upload: ", error);
                            alert("เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ: " + error.message);
                        },
                        () => {
                            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                console.log("File available at", downloadURL);

                                attachedFileURL = downloadURL;
                                attachedFileType = "รูปภาพ";

                                const fileContainer = document.getElementById("fileContainer");
                                fileContainer.innerHTML = `<a href="${downloadURL}" target="_blank">${file.name}</a>`;
                                fileContainer.style.display = "block";
                            });
                        }
                    );
                }
            };
            input.click();
        }

        function attachLink() {
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "วางลิงก์ที่นี่";
            input.style.width = "100%";
            input.style.padding = "5px";

            const modalContent = document.querySelector(".modal-content");
            modalContent.appendChild(input); // เพิ่ม input ลงใน modal

            input.onchange = (e) => {
                const link = e.target.value.trim();
                const videoContainer = document.getElementById("fileContainer");

                // ตรวจสอบว่าลิงก์เป็น YouTube หรือไม่
                if (link.includes("youtube.com/watch")) {
                    const videoId = link.split("v=")[1]; // ดึง video ID
                    const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;

                    const iframe = document.createElement("iframe");
                    iframe.width = "560";
                    iframe.height = "315";
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    iframe.frameBorder = "0";
                    iframe.allow =
                        "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                    iframe.allowFullscreen = true;

                    videoContainer.innerHTML = ""; // ล้างเนื้อหาก่อนหน้า
                    videoContainer.appendChild(iframe);

                    // ถ้าการฝังล้มเหลว ให้แสดงภาพตัวอย่างแทน
                    iframe.onerror = () => {
                        videoContainer.innerHTML = `<a href="${link}" target="_blank"><img src="${thumbnailUrl}" alt="YouTube Thumbnail" style="max-width:100%; border-radius: 10px;" /><p>ดูบน YouTube</p></a>`;
                    };
                } else {
                    // ถ้าลิงก์ไม่ใช่ YouTube ให้แสดงลิงก์ธรรมดา
                    const linkTag = document.createElement("a");
                    linkTag.href = link;
                    linkTag.target = "_blank";
                    linkTag.textContent = link;
                    videoContainer.innerHTML = ""; // ล้างเนื้อหาก่อนหน้า
                    videoContainer.appendChild(linkTag);
                }

                videoContainer.style.display = "block"; // แสดง container
                attachedFileURL = link;
                attachedFileType = "ลิงก์";
            };

            input.click();
        }

        async function submitPost() {
            console.log("Submitting post...");

            const message = document.getElementById("postMessage").value.trim();

            // เช็กว่าแนบไฟล์หรือภาพมาไหม ถ้าไม่มีทั้งข้อความและไฟล์แนบให้แสดงข้อความแจ้งเตือน
            if (message === "" && attachedFileURL === "") {
                alert("Message or attachment is required.");
                return;
            }

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const classroomName = urlParams.get("classroom");
            const email = urlParams.get("email");

            if (!classroomName || !email) {
                alert("Classroom or Email is missing!");
                return;
            }

            // เช็กว่ามีการอัพโหลดรูปภาพเสร็จแล้วหรือไม่
            if (attachedFileType === "รูปภาพ" && attachedFileURL === "") {
                alert("Please wait for the image to upload.");
                return;
            }

            // กำหนดประเภทของโพสต์และเนื้อหาที่จะบันทึก
            let postType = attachedFileType ? attachedFileType : "ข้อความ";
            let content = attachedFileURL ? attachedFileURL : message;

            try {
                // บันทึกข้อมูลโพสต์ลง Firestore
                const postRef = await db.collection("Post").add({
                    ClassroomName: classroomName,
                    Username: window.username,
                    Email: email,
                    PostType: postType,
                    Content: content, // บันทึก URL ของภาพหรือไฟล์ลงไปที่นี่
                    Message: message,
                    Timestamp: timestamp,
                });

                console.log("Post created with ID:", postRef.id);

                // สร้างการแจ้งเตือนให้สมาชิกในห้องเรียนทุกคน
                const subjectDoc = await db.collection("Subjects").where("ClassroomName", "==", classroomName).get();

                if (!subjectDoc.empty) {
                    const subjectData = subjectDoc.docs[0].data();

                    if (subjectData && subjectData.Members) {
                        const members = subjectData.Members;

                        const notificationPromises = members.map((memberEmail) => {
                            if (memberEmail !== email) { // ไม่ต้องแจ้งเตือนตัวเอง
                                return db.collection("Notifications").add({
                                    To: memberEmail,
                                    Message: `${window.username} ได้โพสต์ ${postType} ในห้องเรียน ${classroomName}`,
                                    Type: "Post",
                                    ClassroomName: classroomName,
                                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    isRead: false,
                                });
                            }
                            return null; // ไม่สร้าง notification สำหรับผู้โพสต์เอง
                        });

                        // รอให้การสร้างแจ้งเตือนทั้งหมดเสร็จสิ้น
                        await Promise.all(notificationPromises);
                        console.log("Notifications created for all members except the poster.");
                    } else {
                        console.error("No members found in the classroom:", classroomName);
                    }
                } else {
                    console.error("Subject document not found for classroom:", classroomName);
                }

                alert("Post created successfully and notifications sent!");
                closeModal();
                attachedFileURL = ""; // เคลียร์ตัวแปรสำหรับไฟล์ที่แนบมาหลังจากโพสต์เสร็จสิ้น
                attachedFileType = "";
                document.getElementById("postMessage").value = "";
                document.getElementById("imageContainer").innerHTML = "";

                // รีเฟรชหน้าเว็บหลังจากที่โพสต์เสร็จสิ้น
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            } catch (error) {
                console.error("Error creating post or sending notifications: ", error);
            }
        }

        // Function สำหรับการอัพเดต badge ของการแจ้งเตือนแบบเรียลไทม์
        function updateNotificationBadge(email) {
            db.collection("Notifications")
                .where("To", "==", email)
                .where("isRead", "==", false)
                .onSnapshot((snapshot) => {
                    const unreadCount = snapshot.size;
                    const notificationBadge = document.getElementById("notificationBadge");
                    if (unreadCount > 0) {
                        notificationBadge.style.display = "block";
                        notificationBadge.textContent = unreadCount;
                    } else {
                        notificationBadge.style.display = "none";
                    }
                });
        }

        // เรียกใช้ฟังก์ชันเมื่อหน้าเพจโหลดเสร็จ
        updateNotificationBadge(email);

        function fetchDocumentId(classroomName) {
            db.collection("Subjects")
                .where("ClassroomName", "==", classroomName)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        // Display the Document ID in the input field
                        document.getElementById("documentId").value = doc.id;
                    });
                })
                .catch((error) => {
                    console.error("Error fetching document ID: ", error);
                });
        }

        // Call this function after the page has loaded and classroomName is available
        fetchDocumentId(classroomName);

        // Function to copy the Document ID
        function copyDocumentId() {
            const documentIdInput = document.getElementById("documentId");
            documentIdInput.select();
            document.execCommand("copy");
            alert("Document ID copied: " + documentIdInput.value);
        }
    </script>
</body>

</html>